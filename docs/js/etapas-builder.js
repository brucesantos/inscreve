document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("filtroComponentes"),t=document.querySelectorAll(".list-group-item[data-tipo-componente]"),n=document.querySelector(".coluna-de-etapas");let o='\n<div class="card card-de-etapa mb-3 shadow-sm">\n  <div class="card-body">\n    <div class="cabecalho d-flex justify-content-between align-items-center">\n      <div class="esquerda d-flex align-items-center gap-3">\n        <div class="drag-handle">\n          <svg width="12" height="16" viewBox="0 0 12 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <rect width="12" height="16" fill="none"/>\n            <path d="M2.25 13.75H3.75V12.25H2.25V13.75ZM2.25 15C1.53125 15 1 14.4688 1 13.75V12.25C1 11.5625 1.53125 11 2.25 11H3.75C4.4375 11 5 11.5625 5 12.25V13.75C5 14.4688 4.4375 15 3.75 15H2.25ZM8.25 13.75H9.75V12.25H8.25V13.75ZM8.25 15C7.53125 15 7 14.4688 7 13.75V12.25C7 11.5625 7.53125 11 8.25 11H9.75C10.4375 11 11 11.5625 11 12.25V13.75C11 14.4688 10.4375 15 9.75 15H8.25ZM2.25 7.25V8.75H3.75V7.25H2.25ZM1 8.75V7.25C1 6.5625 1.53125 6 2.25 6H3.75C4.4375 6 5 6.5625 5 7.25V8.75C5 9.46875 4.4375 10 3.75 10H2.25C1.53125 10 1 9.46875 1 8.75ZM8.25 8.75H9.75V7.25H8.25V8.75ZM8.25 10C7.53125 10 7 9.46875 7 8.75V7.25C7 6.5625 7.53125 6 8.25 6H9.75C10.4375 6 11 6.5625 11 7.25V8.75C11 9.46875 10.4375 10 9.75 10H8.25ZM2.25 2.25V3.75H3.75V2.25H2.25ZM1 3.75V2.25C1 1.5625 1.53125 1 2.25 1H3.75C4.4375 1 5 1.5625 5 2.25V3.75C5 4.46875 4.4375 5 3.75 5H2.25C1.53125 5 1 4.46875 1 3.75ZM8.25 3.75H9.75V2.25H8.25V3.75ZM8.25 5C7.53125 5 7 4.46875 7 3.75V2.25C7 1.5625 7.53125 1 8.25 1H9.75C10.4375 1 11 1.5625 11 2.25V3.75C11 4.46875 10.4375 5 9.75 5H8.25Z" fill="#9CA3AF"/>\n          </svg>\n        </div>\n        <div class="nome fw-bold fs-5">${nome}</div>\n      </div>\n      <div class="direita d-flex align-items-center gap-3">\n        ${datas}\n        <div class="acoes d-flex gap-2">\n          <button type="button" class="criar-filho btn btn-outline-primary p-0" style="width: 38px; height: 38px;">\n            <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <path d="M13.9375 5.8125V12.0625H20.1875C20.6953 12.0625 21.125 12.4922 21.125 13C21.125 13.5469 20.6953 13.9375 20.1875 13.9375H13.9375V20.1875C13.9375 20.7344 13.5078 21.125 13 21.125C12.4531 21.125 12.0625 20.7344 12.0625 20.1875V13.9375H5.8125C5.26562 13.9375 4.875 13.5469 4.875 13C4.875 12.4922 5.26562 12.0625 5.8125 12.0625H12.0625V5.8125C12.0625 5.30469 12.4531 4.875 13 4.875C13.5078 4.875 13.9375 5.30469 13.9375 5.8125Z" fill="currentColor"/>\n            </svg>\n          </button>\n          <button type="button" class="excluir btn btn-outline-primary p-0 btn-excluir-etapa" style="width: 38px; height: 38px;">\n            <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <path d="M11.1641 4.875C11.0469 4.875 10.9688 4.95312 10.8906 5.03125L10.1484 6.125H15.8125L15.0703 5.03125C15.0312 4.95312 14.9141 4.875 14.7969 4.875H11.1641ZM18.0781 6.125H18.5859H20.5H20.8125C21.3203 6.125 21.75 6.55469 21.75 7.0625C21.75 7.60938 21.3203 8 20.8125 8H20.3438L19.4062 20.6953C19.2891 22.0234 18.2344 23 16.9062 23H9.05469C7.72656 23 6.67188 22.0234 6.55469 20.6953L5.61719 8H5.1875C4.64062 8 4.25 7.60938 4.25 7.0625C4.25 6.55469 4.64062 6.125 5.1875 6.125H5.5H7.375H7.88281L9.32812 3.97656C9.71875 3.39062 10.4219 3 11.1641 3H14.7969C15.5391 3 16.2422 3.39062 16.6328 3.97656L18.0781 6.125ZM18.4688 8H7.49219L8.42969 20.5781C8.46875 20.8906 8.74219 21.125 9.05469 21.125H16.9062C17.2188 21.125 17.4922 20.8906 17.5312 20.5781L18.4688 8Z" fill="currentColor"/>\n            </svg>\n          </button>\n          <button type="button" class="editar btn btn-outline-primary p-0" style="width: 38px; height: 38px;">\n            <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">\n              <path d="M4.40625 17.1016C4.52344 16.7109 4.71875 16.3203 4.95312 16.0078V15.9688H4.99219C5.07031 15.8516 5.1875 15.7344 5.26562 15.6562L17.1406 3.78125C18.1172 2.80469 19.7188 2.80469 20.6953 3.78125L22.2188 5.30469C22.3359 5.42188 22.4531 5.57812 22.5312 5.69531C23.1953 6.67188 23.0781 8 22.2188 8.85938L10.3438 20.7344C10.3047 20.7734 10.2266 20.8125 10.1875 20.8906C10.1484 20.9297 10.0703 20.9688 10.0312 21.0078V21.0469H9.99219C9.67969 21.2812 9.28906 21.4766 8.89844 21.5938L5.85156 22.4922L4.17188 23C3.85938 23.0781 3.50781 23 3.27344 22.7266C3 22.4922 2.92188 22.1406 3.03906 21.8281L3.50781 20.1484L4.40625 17.1016ZM17.9609 10.4609L15.5391 8.03906L8.27344 15.3047L8.74219 17.2578L10.6953 17.7266L17.9609 10.4609ZM6.78906 17.0234L6.32031 17.3359C6.28125 17.4141 6.24219 17.5312 6.20312 17.6484L5.92969 18.5469L5.30469 20.6953L7.45312 20.0703L8.35156 19.7969C8.46875 19.7578 8.58594 19.7188 8.66406 19.6797L8.97656 19.25L7.76562 18.9375C7.41406 18.8594 7.14062 18.5859 7.0625 18.2344L6.78906 17.0234ZM15.3047 11.5547L11.5547 15.3047C11.3203 15.5391 10.8906 15.5391 10.6562 15.3047C10.4219 15.0703 10.4219 14.6797 10.6562 14.4453L14.4062 10.6953C14.6406 10.4219 15.0703 10.4219 15.3047 10.6953C15.5391 10.9297 15.5391 11.3203 15.3047 11.5547Z" fill="currentColor"/>\n            </svg>\n          </button>\n        </div>\n      </div>\n    </div>\n    <div class="children"></div>\n  </div>\n</div>';const a=document.querySelector("#modalEtapas .modal-footer .btn-primary");function d(e){if(!e)return"DD/MM/AAAA HH:mm";const t=new Date(e);return`${String(t.getDate()).padStart(2,"0")}/${String(t.getMonth()+1).padStart(2,"0")}/${t.getFullYear()} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}let i;function c(e,t,a=null,d="DD/MM/AAAA HH:mm",c="DD/MM/AAAA HH:mm"){const r=a?"":`\n      <div class="datas opacity-75">\n        <span class="data-ini">${d}</span>\n        <span class="mx-1 opacity-50">-</span>\n        <span class="data-fim">${c}</span>\n      </div>\n    `,m=o.replace("${nome}",t).replace("${datas}",r);if(a){a.insertAdjacentHTML("beforeend",m);const t=a.lastElementChild;if(e){t.querySelector(".children").innerHTML=`<div class="componente-${e}"></div>`}l(t),s(a)}else{n.insertAdjacentHTML("beforeend",m);const t=n.lastElementChild;if(e){t.querySelector(".children").innerHTML=`<div class="componente-${e}"></div>`}l(t),i&&i.option("animation",150)}}function l(e){const t=e.querySelector(".btn-excluir-etapa");t&&t.addEventListener("click",(function(){confirm("Tem certeza que deseja excluir esta etapa?")&&this.closest(".card-de-etapa").remove()}));const n=e.querySelector(".criar-filho");n&&n.addEventListener("click",(function(){const e=this.closest(".card-de-etapa").querySelector(".children");document.querySelectorAll(".list-group-item[data-tipo-componente]").forEach((t=>{const n=t.cloneNode(!0);n.addEventListener("click",(function(t){t.preventDefault();const n=this.getAttribute("data-tipo-componente");console.log("Componente selecionado:",n);bootstrap.Modal.getInstance(document.getElementById("modalComponentes")).hide();const o=createComponentEditModal(n);if(o){const t=document.getElementById(`modalEdit${n}`);t&&t.remove(),document.body.insertAdjacentHTML("beforeend",o);const a=document.getElementById(`modalEdit${n}`),d=document.getElementById(`formEdit${n}`),i=a.querySelector(".modal-footer .btn-primary");i&&i.addEventListener("click",(function(){d.dispatchEvent(new Event("submit"))})),d.addEventListener("submit",(function(t){t.preventDefault();const o=new FormData(d).get("name")||`Componente ${n}`;saveComponentEdit(n),console.log("Adicionando componente após edição:",n,o),c(n,o,e);bootstrap.Modal.getInstance(a).hide()}));new bootstrap.Modal(a).show()}else console.log("Adicionando componente filho direto (fallback):",n),c(n,`Componente ${n}`,e)})),t.parentNode.replaceChild(n,t)}));new bootstrap.Modal(document.getElementById("modalComponentes")).show()}));const o=e.querySelector(".editar");o&&o.addEventListener("click",(function(){const e=this.closest(".card-de-etapa").querySelector(".children").firstElementChild;if(e){const t=e.className.replace("componente-","");console.log("Editando componente do tipo:",t);const n=createComponentEditModal(t);if(n){const e=document.getElementById(`modalEdit${t}`);e&&e.remove(),document.body.insertAdjacentHTML("beforeend",n);const o=document.getElementById(`modalEdit${t}`),a=document.getElementById(`formEdit${t}`),d=this.closest(".card-de-etapa").querySelector(".nome").textContent;a.querySelector('[name="name"]').value=d;const i=o.querySelector(".modal-footer .btn-primary");i&&i.addEventListener("click",(function(){a.dispatchEvent(new Event("submit"))})),a.addEventListener("submit",(function(e){e.preventDefault();const n=new FormData(a).get("name")||d;saveComponentEdit(t),this.closest(".card-de-etapa").querySelector(".nome").textContent=n;bootstrap.Modal.getInstance(o).hide()}));new bootstrap.Modal(o).show()}}}))}function s(e){"undefined"!=typeof Sortable&&Sortable.create(e,{animation:150,handle:".drag-handle",ghostClass:"card-de-etapa-ghost",chosenClass:"card-de-etapa-chosen",dragClass:"card-de-etapa-drag",group:"nested",onStart:function(e){document.body.classList.add("dragging-card")},onEnd:function(e){document.body.classList.remove("dragging-card");const t=e.item;t.classList.add("highlight-card"),setTimeout((()=>{t.classList.remove("highlight-card")}),800)}})}a&&a.addEventListener("click",(function(){const e=document.getElementById("nomeEtapa").value,t=document.getElementById("dataInicio").value,n=document.getElementById("dataFim").value;c(null,e||"Nova etapa",null,t?d(t):"DD/MM/AAAA HH:mm",n?d(n):"DD/MM/AAAA HH:mm"),document.getElementById("nomeEtapa").value="",document.getElementById("dataInicio").value="",document.getElementById("dataFim").value="";bootstrap.Modal.getInstance(document.getElementById("modalEtapas")).hide()})),n&&"undefined"!=typeof Sortable&&(i=Sortable.create(n,{animation:150,handle:".drag-handle",ghostClass:"card-de-etapa-ghost",chosenClass:"card-de-etapa-chosen",dragClass:"card-de-etapa-drag",forceFallback:!1,fallbackTolerance:3,scrollSpeed:40,scrollSensitivity:80,onStart:function(e){document.body.classList.add("dragging-card")},onEnd:function(e){document.body.classList.remove("dragging-card"),console.log("Nova ordem estabelecida");const t=e.item;t.classList.add("highlight-card"),setTimeout((()=>{t.classList.remove("highlight-card")}),800)}})),e&&e.addEventListener("input",(function(){const e=this.value.toLowerCase().trim();t.forEach((t=>{const n=t.querySelector(".fw-bold").textContent.toLowerCase(),o=t.querySelector(".text-muted").textContent.toLowerCase();n.includes(e)||o.includes(e)?t.style.display="":t.style.display="none"}))})),t.forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault();const t=this.getAttribute("data-tipo-componente"),n=createComponentEditModal(t);if(n){const e=document.getElementById(`modalEdit${t}`);e&&e.remove(),document.body.insertAdjacentHTML("beforeend",n);new bootstrap.Modal(document.getElementById(`modalEdit${t}`)).show();document.getElementById(`formEdit${t}`).addEventListener("submit",(function(e){e.preventDefault(),saveComponentEdit(t)}))}}))})),document.querySelectorAll(".card-de-etapa").forEach((e=>{l(e);const t=e.querySelector(".children");t&&s(t)}))}));